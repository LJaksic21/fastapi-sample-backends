# fastapi-sample-backends

This project is a teaching- and interview-ready FastAPI backend that implements a double-entry ledger with strict idempotency, durable storage, and automated tests. It is structured so a reviewer can skim the README, run the app quickly, and understand the architecture at a glance.

## Table of Contents
1. [Project Snapshot](#project-snapshot)
2. [Quickstart](#quickstart)
3. [Running Tests](#running-tests)
4. [Configuration](#configuration)
5. [Architecture Overview](#architecture-overview)
6. [API Preview](#api-preview)
7. [Full Requirements Brief](#full-requirements-brief)

## Project Snapshot
- **Framework:** FastAPI (Python 3.11+)
- **Persistence:** SQLModel on SQLite by default; swap to Postgres or another engine via an env var
- **Testing:** `pytest` using FastAPI’s `TestClient`
- **Highlights:**
  - Account lifecycle (create, detail, statements)
  - Deposits/withdrawals with non-negative balance enforcement
  - Transfers with atomic double-entry postings
  - Idempotent POST routes backed by a persistent key→response table
  - Cursor-based statement pagination

## Quickstart
```bash
# 1. Set up a virtual environment
python3 -m venv .fastapi-backend-env
source .fastapi-backend-env/bin/activate

# 2. Install dependencies
python -m pip install --upgrade pip
python -m pip install -r requirements.txt

# 3. Launch the API
touch .env  # optional if you want to customize settings
uvicorn mini_ledger.app.main:app --reload
```
Visit `http://127.0.0.1:8000/docs` for the autogenerated OpenAPI explorer.

## Running Tests
```bash
python -m pytest mini_ledger/app/tests -q
```
The suite provisions a temporary SQLite database for every run, exercises idempotent replays, insufficient-fund conflicts, pagination, and cursor validation, then tears the database down again.

## Configuration
Settings live in `mini_ledger/app/core/config.py` and are powered by `pydantic-settings`. Override them via environment variables (prefix `LEDGER_`) or a local `.env` file.

| Variable | Default | Purpose |
| --- | --- | --- |
| `LEDGER_APP_NAME` | `Mini Ledger API` | FastAPI title & log prefix |
| `LEDGER_DATABASE_URL` | `sqlite:///mini_ledger.db` | Any SQLAlchemy-compatible connection string |
| `LEDGER_LOG_LEVEL` | `INFO` | Root logging level |

Example: run on Postgres locally without touching code
```bash
export LEDGER_DATABASE_URL="postgresql+psycopg://user:pass@localhost:5432/mini_ledger"
uvicorn mini_ledger.app.main:app --reload
```

## Architecture Overview
- **API (`mini_ledger/app/api/`)**: Routers declare endpoints and Pydantic schemas only. `api/exceptions.py` registers global handlers that translate domain errors into clean `400/404/409` responses.
- **Services (`mini_ledger/app/services/`)**: `LedgerService` encapsulates business rules and structured logging. A dedicated `LedgerRepository` performs SQLModel operations (accounts, ledger entries, idempotency records).
- **Persistence (`mini_ledger/app/core/db.py`)**: Engine creation consults configuration and supports multiple backends. The FastAPI lifespan hook runs migrations (`SQLModel.metadata.create_all`) on startup.
- **Tests (`mini_ledger/app/tests/`)**: Pytest overrides the session dependency to point at a temporary engine, ensuring isolation between runs.

## API Preview
Every mutating endpoint requires an `Idempotency-Key` header (UUID recommended).

| Method & Path | Description |
| --- | --- |
| `POST /accounts` | Create an account (`{"owner_name": "Alice"}`) → returns snapshot with balance `0`. |
| `GET /accounts/{id}` | Fetch current account data. |
| `POST /accounts/{id}/deposit` | Increase balance; replays (same key/body) return cached response. |
| `POST /accounts/{id}/withdraw` | Decrease balance; returns `409` if funds are insufficient. |
| `POST /transfers` | Atomic debit/credit between accounts; rejects self-transfer or insufficient funds. |
| `GET /accounts/{id}/statement?limit=50&cursor=…` | Recent ledger entries (newest first) with a cursor for pagination. |

### Error Semantics
- `400` – invalid input (bad cursor, self-transfer attempt)
- `404` – account not found
- `409` – conflict (insufficient funds, idempotency key reused with different payload)
- `422` – validation errors handled by FastAPI/Pydantic

## Full Requirements Brief

**Theme:** Core fintech ledger logic, data integrity, idempotency  
**Difficulty:** Medium (60–75 min)

### Goal
Expose a double-entry ledger API: create accounts, deposit/withdraw, transfer between accounts, and fetch statements. Prevent negative balances. Support idempotent POSTs.

### Environment & Allowed Tools
- Python 3.11+
- fastapi, uvicorn, pydantic (optionally sqlmodel/sqlite3; in-memory acceptable)
- Testing: pytest + httpx test client (or starlette.testclient)

### Data Model (Minimal)
- `Account`: `{id: str(UUID), owner_name: str, created_at: datetime, balance: int}` (balance stored as integer minor units)
- `LedgerEntry`: `{id: UUID, ts: datetime, account_id: UUID, amount: int, type: "DEBIT"|"CREDIT", ref: str}`
- `Transfer`: logical pair of entries (CREDIT dest, DEBIT source) tracked via a single `transfer_id`
- Using integer cents avoids float errors

### Endpoints
- `POST /accounts`
- `POST /accounts/{id}/deposit`
- `POST /accounts/{id}/withdraw`
- `POST /transfers`
- `GET /accounts/{id}`
- `GET /accounts/{id}/statement?limit=50&cursor=<token>`

### Business Rules
- No negative balances
- Double-entry invariant (each transfer issues one DEBIT + one CREDIT)
- Idempotency using an on-disk key→response cache

### Errors
- `400` invalid input
- `404` not found
- `409` conflicts (insufficient funds or idempotency mismatch)
- `422` validation failures

### Required Test Scenarios (5–7)
- Create accounts; deposit; withdraw happy path
- Insufficient funds returns `409`
- Transfer creates two entries and conserves total
- Idempotent deposit: replay returns same payload without double crediting
- Statement reverse-chronological order with pagination

### Evaluation Rubric (Suggested)
- Correctness 40% (rules & invariants)
- API design & validation 25%
- Code structure & clarity 20%
- Tests 10%
- Extras 5% (auth, README, OpenAPI polish)

### Stretch Goals (if time)
- JWT bearer auth on mutating routes
- `BackgroundTask` receipts or webhooks
- Promote SQLite to Postgres with zero code changes
